#!/bin/sh

##
# Establish an SSH tunnel to saws.syapse.com
# and a VNC connection through it.
#

##
# Kill open ssh tunnels to the vnc_host.
kill_ssh_tunnel() {
  echo "Checking for an open SSH tunnel..."
  echo ssh -S ~/.ssh/vnc-ctrl-sock -O exit "$1"
  ssh -S ~/.ssh/vnc-ctrl-sock -O exit "$1"
}

##
# Open a new SSH tunnel.
open_ssh_tunnel() {
  echo "Opening a new SSH tunnel..."
  ssh -M -S ~/.ssh/vnc-ctrl-sock -NfL "5901:localhost:59$2" "$1"
}

##
# Kill the remote VNC server.
kill_vnc() {
  echo "Killing the remote VNC server..."
  ssh "$1" "vncserver -kill :$2"
}

##
# Start the remote VNC server.
start_vnc() {
  echo "Starting a new remote VNC server..."
  ssh "$1" "vncserver :$2 -geometry "$3" -dpi "$4" -localhost"
}

##
# Wait for the listener to be ready
wait_for_listener() {
  echo "Waiting for localhost:5901"

  while ! nc -z localhost 5901; do   
    sleep 0.25 # wait for 1/4 of the second before check again
    echo "    ... waiting ..."
  done

  echo "Ready"
}

##
# Describe what to do next.
fini() {
  echo 'VNC is running and an SSH tunnel is established.'
  echo 'You can now connect to vnc at localhost:5901'
  echo 'On macOS you can do this with `open vnc://localhost:5901`'
}

main() {
  vnc_username=arnonm #$1
  vnc_display=43 #$2
  geometry="${3:-1920x1080}"
  dpi="${4:-96}"
  vnc_host="${5:-saws.syapse.com}"
  vnc_target="${vnc_username}@${vnc_host}"

  echo "VNC target: $vnc_target"

  kill_ssh_tunnel "$vnc_target"
  kill_vnc "$vnc_target" "$vnc_display"
  open_ssh_tunnel "$vnc_target" "$vnc_display"
  start_vnc "$vnc_target" "$vnc_display" "$geometry" "$dpi"

  wait_for_listener

  fini
  open vnc://localhost:5901
}

main "$@"

